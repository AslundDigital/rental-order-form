<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Rental Order Form</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    input, button, textarea { padding: 8px; margin: 5px 0; width: 100%; max-width: 400px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .hidden { display: none; }
    .center { text-align: center; }
    input.quantity { width: 60px; }
  </style>
</head>
<body>

<div id="step1">
  <h2>Customer Information</h2>
  <form id="form1">
    <input type="text" name="firstName" placeholder="First Name" required pattern="[A-Za-z]+" />
    <input type="text" name="lastName" placeholder="Last Name" required pattern="[A-Za-z]+" />
    <input type="email" name="email" placeholder="Email" required />
    <input type="tel" name="phone" placeholder="Phone (e.g., 1234567890)" required pattern="\d{10}" />
    
<label>Rental Date:
  <input type="date" name="rentalDate" required />
  <select name="rentalTime" required>
    <option value="">-- Time --</option>
    <option value="08:00">8:00 AM</option>
    <option value="08:30">8:30 AM</option>
    <option value="09:00">9:00 AM</option>
    <option value="09:30">9:30 AM</option>
    <option value="10:00">10:00 AM</option>
    <option value="10:30">10:30 AM</option>
    <option value="11:00">11:00 AM</option>
    <option value="11:30">11:30 AM</option>
    <option value="12:00">12:00 PM</option>
    <option value="12:30">12:30 PM</option>
    <option value="13:00">1:00 PM</option>
    <option value="13:30">1:30 PM</option>
    <option value="14:00">2:00 PM</option>
    <option value="14:30">2:30 PM</option>
    <option value="15:00">3:00 PM</option>
    <option value="15:30">3:30 PM</option>
    <option value="16:00">4:00 PM</option>
    <option value="16:30">4:30 PM</option>
    <option value="17:00">5:00 PM</option>
  </select>
</label><br>

<label>Return Date:
  <input type="date" name="returnDate" required />
  <select name="returnTime" required>
    <option value="">-- Time --</option>
    <option value="08:00">8:00 AM</option>
    <option value="08:30">8:30 AM</option>
    <option value="09:00">9:00 AM</option>
    <option value="09:30">9:30 AM</option>
    <option value="10:00">10:00 AM</option>
    <option value="10:30">10:30 AM</option>
    <option value="11:00">11:00 AM</option>
    <option value="11:30">11:30 AM</option>
    <option value="12:00">12:00 PM</option>
    <option value="12:30">12:30 PM</option>
    <option value="13:00">1:00 PM</option>
    <option value="13:30">1:30 PM</option>
    <option value="14:00">2:00 PM</option>
    <option value="14:30">2:30 PM</option>
    <option value="15:00">3:00 PM</option>
    <option value="15:30">3:30 PM</option>
    <option value="16:00">4:00 PM</option>
    <option value="16:30">4:30 PM</option>
    <option value="17:00">5:00 PM</option>
  </select>
</label><br>

    <button type="submit">Next</button>
  </form>
</div>

<div id="step2" class="hidden">
  <h2>Item Selection</h2>
  <form id="form2">
    <table id="itemsTable">
      <thead>
        <tr><th>Item</th><th>Rental/Day</th><th>Quantity</th><th>Line Total</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="center">
      <button type="submit">Next</button>
    </div>
  </form>
</div>

<div id="step3" class="hidden">
  <h2>Additional Requests</h2>
  <form id="form3">
    <p><strong>Please include any items not listed that you need. We can provide them through our rental partners.</strong></p>
    <textarea name="message" rows="5" placeholder="List additional items or notes here..."></textarea>

    <h3>STAFF</h3>
    <table>
      <thead><tr><th>Role</th><th>Quantity</th></tr></thead>
      <tbody>
        <tr><td>Grip</td><td><input type="number" name="staff_Grip" min="0" class="quantity" /></td></tr>
        <tr><td>Craft Service</td><td><input type="number" name="staff_Craft" min="0" class="quantity" /></td></tr>
        <tr><td>Production Support</td><td><input type="number" name="staff_Production" min="0" class="quantity" /></td></tr>
      </tbody>
    </table>

    <div class="center">
      <button type="submit">Submit</button>
    </div>
  </form>
</div>

<div id="confirmation" class="hidden center">
  <h3>Thank you! Your order has been received.</h3>
</div>

<script>
let customerEmail = "";

document.getElementById("form1").addEventListener("submit", function(e) {
  e.preventDefault();
  const form = new FormData(this);
  fetch('https://script.google.com/macros/s/AKfycbwfd4OkZrMObAc0NwGXpckka--GgSz2olgpXFZwxOeQyBAkS5DJktevKHhNXv01yT1c/exec', {
    method: 'POST',
    body: new URLSearchParams({
      type: 'step1',
      firstName: form.get("firstName"),
      lastName: form.get("lastName"),
      email: form.get("email"),
      phone: form.get("phone"),
      rentalDate: form.get("rentalDate"),
      returnDate: form.get("returnDate")
    })
  })
  .then(res => res.text())
  .then(res => {
    if (res === "STEP1_OK") {
      customerEmail = form.get("email");
      document.getElementById("step1").classList.add("hidden");
      document.getElementById("step2").classList.remove("hidden");
      loadInventory();
    }
  });
});

function loadInventory() {
  fetch('https://script.google.com/macros/s/AKfycbwfd4OkZrMObAc0NwGXpckka--GgSz2olgpXFZwxOeQyBAkS5DJktevKHhNXv01yT1c/exec')
    .then(res => res.json())
    .then(items => {
      const tbody = document.querySelector("#itemsTable tbody");
      items.forEach(item => {
        if (!item.price || isNaN(item.price)) return;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.name}</td>
          <td>$${item.price}</td>
          <td><input type="number" min="0" data-price="${item.price}" data-name="${item.name}" class="quantity" /></td>
          <td class="line-total">$0</td>
        `;
        tbody.appendChild(row);
      });
      tbody.querySelectorAll("input").forEach(input => {
        input.addEventListener("input", function() {
          const qty = parseInt(this.value) || 0;
          const price = parseFloat(this.dataset.price);
          const total = qty * price;
          this.closest("tr").querySelector(".line-total").innerText = `$${total.toFixed(2)}`;
        });
      });
    });
}

document.getElementById("form2").addEventListener("submit", function(e) {
  e.preventDefault();
  const items = [];
  document.querySelectorAll("#itemsTable input").forEach(input => {
    const qty = parseInt(input.value);
    if (qty > 0) {
      items.push({
        name: input.dataset.name,
        quantity: qty,
        price: parseFloat(input.dataset.price)
      });
    }
  });
  if (items.length === 0) return alert("Please enter at least one quantity.");

  fetch('https://script.google.com/macros/s/AKfycbwfd4OkZrMObAc0NwGXpckka--GgSz2olgpXFZwxOeQyBAkS5DJktevKHhNXv01yT1c/exec', {
    method: 'POST',
    body: new URLSearchParams({
      type: 'step2',
      email: customerEmail,
      items: JSON.stringify(items)
    })
  })
  .then(res => res.text())
  .then(res => {
    if (res === "STEP2_OK") {
      document.getElementById("step2").classList.add("hidden");
      
    }
  });
});

document.getElementById("form3").addEventListener("submit", function(e) {
  e.preventDefault();
  const form = new FormData(this);
  const staff = {
    Grip: form.get("staff_Grip"),
    Craft: form.get("staff_Craft"),
    Production: form.get("staff_Production")
  };
  fetch('https://script.google.com/macros/s/AKfycbwfd4OkZrMObAc0NwGXpckka--GgSz2olgpXFZwxOeQyBAkS5DJktevKHhNXv01yT1c/exec', {
    method: 'POST',
    body: new URLSearchParams({
      type: 'step3',  // actually submitted to OrderItems as a second entry
      email: customerEmail,
      message: form.get("message"),
      staff: JSON.stringify(staff)
    })
  })
  .then(res => res.text())
  .then(res => {
    if (res === "STEP3_OK") {
      document.getElementById("step3").classList.add("hidden");
      document.getElementById("confirmation").classList.remove("hidden");
    }
  });
});
</script>
</body>
</html>
