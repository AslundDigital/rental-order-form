<!DOCTYPE html>
<html>
<head>
  <title>Rental Order Form</title>
  <meta charset="UTF-8" />
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px; }
    h2 { border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    label { display: block; margin: 10px 0 5px; }
    input, textarea, select { width: 100%; padding: 8px; margin-bottom: 15px; }
    .item-row { display: flex; align-items: center; margin-bottom: 10px; }
    .item-row span { flex: 1; }
    .item-row input { width: 60px; }
    .hidden { display: none; }
    .step { margin-bottom: 30px; }
    button { padding: 10px 20px; }
  </style>
</head>
<body>
  <h1>Rental Order Form</h1>
  <form id="rentalForm">
    <!-- Step 1: Customer Info -->
    <div class="step" id="step1">
      <h2>Step 1: Your Information</h2>
      <label>First Name<input type="text" name="firstName" required></label>
      <label>Last Name<input type="text" name="lastName" required></label>
      <label>Email<input type="email" name="email" required></label>
      <label>Phone<input type="tel" name="phone" required></label>
      <label>Rental Date<input type="date" name="rentalDate" required></label>
      <label>Return Date<input type="date" name="returnDate" required></label>
      <button type="button" onclick="showStep(2)">Next</button>
    </div>

    <!-- Step 2: Items -->
    <div class="step hidden" id="step2">
      <h2>Step 2: Select Items</h2>
      <div id="itemsContainer"></div>
      <button type="button" onclick="showStep(1)">Back</button>
      <button type="button" onclick="showStep(3)">Next</button>
    </div>

    <!-- Step 3: Comments and Submit -->
    <div class="step hidden" id="step3">
      <h2>Step 3: Additional Comments</h2>
      <label>Comments<textarea name="comment"></textarea></label>
      <button type="button" onclick="showStep(2)">Back</button>
      <button type="submit">Submit</button>
    </div>
  </form>

  <div id="message"></div>

  <script>
    const webAppURL = "https://script.google.com/macros/s/AKfycbwchjoMLVXNGaYMo89UdH1zsksL9JnORQVDse2mKi0K8l2cTHuc92MK6P0m0WGIaNb7/exec";

    function showStep(step) {
      document.querySelectorAll('.step').forEach((el, i) => {
        el.classList.toggle('hidden', i !== (step - 1));
      });
    }

    // Load inventory from Sheet
    fetch(webAppURL + "?type=inventory")
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById('itemsContainer');
        data.forEach(item => {
          const row = document.createElement('div');
          row.className = 'item-row';
          row.innerHTML = `
            <span>${item.name} ($${item.price}/day)</span>
            <input type="number" min="0" data-name="${item.name}" data-price="${item.price}" placeholder="Qty">
          `;
          container.appendChild(row);
        });
      });

    // Handle form submission
    document.getElementById("rentalForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const form = e.target;
      const items = [];
      document.querySelectorAll('#itemsContainer input').forEach(input => {
        const qty = parseInt(input.value);
        if (qty > 0) {
          items.push({
            name: input.dataset.name,
            price: parseFloat(input.dataset.price),
            quantity: qty
          });
        }
      });

      if (items.length === 0) {
        alert("Please select at least one item.");
        return;
      }

      const formData = new FormData(form);
      const payload = {
        type: "final",
        firstName: formData.get("firstName"),
        lastName: formData.get("lastName"),
        email: formData.get("email"),
        phone: formData.get("phone"),
        rentalDate: formData.get("rentalDate"),
        returnDate: formData.get("returnDate"),
        comment: formData.get("comment"),
        items: JSON.stringify(items)
      };

      fetch(webAppURL, {
        method: "POST",
        body: new URLSearchParams(payload)
      })
        .then(res => res.text())
        .then(response => {
          document.getElementById("rentalForm").reset();
          showStep(1);
          document.getElementById("message").innerText = "Order submitted successfully!";
        })
        .catch(err => {
          document.getElementById("message").innerText = "Error submitting order.";
        });
    });
  </script>
</body>
</html>
